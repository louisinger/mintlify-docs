---
title: "Batch Swaps"
description: "How VTXOs achieve Bitcoin Finality"
icon: "rotate"
---

Batch swaps let users transition VTXOs from preconfirmed state to Bitcoin finality without exiting Arkade. Three reasons to settle:

1. **Trust Surface**: Preconfirmed VTXOs rely on the operator's integrity. A malicious operator can sign conflicting transactions
2. **VTXO Chain Depth**: Deeply chained VTXOs have high exit costs, making unilateral exit economically unviable
3. **VTXO Renewal**: VTXOs must be renewed before batch expiry. If renewal is missed, the operator can claim the respective VTXO upon bacth expiration.

Batch swaps re-anchor virtual funds to Bitcoin via a commitment transaction, inheriting [Bitcoin finality](/learn/security/transaction-finality#bitcoin-finality) and resetting expiry timers. The process is atomic and users keep custody throughout. Atomicity is enforced through connector outputs and forfeit transactions.

## Commitment Transactions

Commitment Transactions are the single onchain footprint that underpins the Arkade protocol. A commitment transaction is created through a coordinated process where users register their transaction requests to be included in a batch.

The Arkade Operator validates all requests and confirms participant availability before constructing the commitment transaction and initiating the multi-party signing session.

A commitment transaction contains two outputs:

<div style={{ display:"flex",justifyContent:"center" }}>
<img
  className="block dark:hidden"
  src="/images/ark/commitmenttxlight.png"
  alt="Spending conditions"
  style={{ width:"70%",height:"auto" }}
/>

</div>

<div style={{ display:"flex",justifyContent:"center" }}>
<img
  className="hidden dark:block mx-auto"
  src="/images/ark/commitmenttxdark.png"
  alt="Spending conditions"
  style={{ width:"70%",height:"auto" }}
/>
</div>

- **Batch Output**: Encapsulates multiple users' ownership claims in a tree of presigned virtual transactions
- **Connector Output**: A [connector output](/learn/pillars/connectors) is a dust-amount output that ensures atomicity during batch swaps and VTXO exits by providing virtual anchors for forfeit transactions.


<Info>
  Find the [detailed client workflow for onchain settlement](https://docs.arkadeos.com/arkd/txs/onchain-settlement#client-workflow%3A-participating-in-a-batch-swap) in the Server & API section
</Info>

## Forfeit Transactions

Forfeit transactions are the critical mechanism enabling atomic batch swaps. When users swap VTXOs, they sign a forfeit transaction that relinquishes their old VTXO to the operator, but only if the new batch successfully confirms onchain.

Forfeit Transactions serve two main purposes:

  1. Assure the user can forfeit securely on old funds, as those can only be claimed by the operator if new VTXOs are being created via a broadcasted commitment transaction
  2. [Protect the operator against potential user fraud](/arkd/server-security/forfeit-txs), if the user attempted to double-spend forfeited funds


### Transaction Structure

Forfeit transactions follow a specific format ensuring atomicity:

**Inputs:**

- One VTXO input (the position being swapped)
- One connector input (links to the new commitment transaction)

**Outputs:**

- Forfeit output (transfers value to operator)
- Anchor output (zero-value output for fee management)

The anchor output in forfeit transactions is a zero-value output with a specific script used for fee bumping through Child-Pays-For-Parent (CPFP) transactions. When a forfeit transaction needs higher fees for confirmation, the system creates a child transaction that spends this anchor output and pays additional fees.

## Intents

When users want to participate in a batch swap for Bitcoin finality, they submit an intent to the operator. The operator validates this transaction declaration and, if valid, includes the user's intent in the next commitment transaction.

Arkade intents provide cryptographic ownership proof via [BIP322](/learn/glossary#bip322) for any inputs a user wishes to redeem, whether offchain VTXOs, onchain UTXOs, or expired coins. The intent also specifies the exact outputs the user expects to receive.

This design separates control from coordination: users maintain complete control of their keys while the operator handles batch settlement logistics and the Arkade Signer provides necessary cosignatures.

<Tip>
  If a user choses to delegate VTXO renewal and circumvent the corresponding liveness requirement, they never give up keys or fund control in the process, preserving autonomy while reducing operational overhead.
</Tip>

<Info>Find the [detailed intent system description](/arkd/components/intent-system) in the Server & API section</Info> 


## Batch Swaps: Step-by-Step process

<Steps>
  <Step title="Participation Signaling" titleSize="h3">
    Users initiate batch swaps by submitting an intent to the operator containing:
    - VTXOs to be swapped
    - Desired parameters for new VTXOs (scripts, amounts)
    - Cosigner keys for the new batch's transaction tree
  </Step>
  <Step title="Commitment Transaction Construction" titleSize="h3">
    The operator builds a new commitment transaction featuring:

    - [Batch output](/learn/pillars/batch-outputs): Aggregates all participants' new VTXOs
    - Connector output: Enables atomic coordination between old and new states
  </Step>
  <Step title="Virtual Transaction Tree Setup" titleSize="h3">
    The operator constructs the virtual transaction tree for the batch output, defining:

    - Unilateral exit paths for each participant
    - Collaborative spending conditions and timelocks
    - Anchor outputs for fee attachment capabilities

    This structure ensures every VTXO maintains enforceable settlement guarantees.
  </Step>
  <Step title="Forfeit Transaction Construction" titleSize="h3">
    A forfeit transaction links old and new states by:

    - Spending the user's preconfirmed VTXOs
    - Consuming the virtual connector output
    - Transferring value to the operator for liquidity rotation

    The virtual connector ensures the operator can only claim forfeited VTXOs after broadcasting the commitment transaction.
  </Step>
  <Step title="Signing Phase" titleSize="h3">
    Both parties provide necessary signatures:

    - Users sign forfeit transactions after verifying the virtual tree
    - The Arkade Signer signs the commitment transaction and new virtual paths

      This mutual dependency ensures atomicity. Neither party can finalize without the other's cooperation.
  </Step>
  <Step title="Broadcast and Confirmation" titleSize="h3">
    The operator broadcasts the commitment transaction to Bitcoin:

    - Upon confirmation, new VTXOs become valid and enforceable
    - Old VTXOs are invalidated through the forfeit mechanism
    - System state advances without requiring unilateral exits
  </Step>
</Steps>

<Info>
  Find the [detailed onchain settlement mechanics](/arkd/txs/onchain-settlement) in the Server & API section
</Info>